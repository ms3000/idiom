<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Idiom Daily - ì˜ì–´ ìˆ™ì–´ í•™ìŠµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê²½ê³  ë©”ì‹œì§€ ìˆ¨ê¸°ê¸° */
        .tw-dev-warning {
            display: none !important;
        }
        
        /* Container Query ì§€ì›ì„ ìœ„í•œ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
        .container-query {
            container-type: inline-size;
        }
        
        @container (min-width: 640px) {
            .container\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        
        @container (max-width: 639px) {
            .container\:text-sm {
                font-size: 0.875rem;
            }
        }

        /* ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ ê°•í™” */
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: translateY(0);
        }

        /* í´ë¦­ ê°€ëŠ¥í•œ ìš”ì†Œë“¤ ê°•ì¡° */
        [onclick], button {
            cursor: pointer !important;
            user-select: none;
        }

        /* ì§„í–‰ë¥  ë°” ì• ë‹ˆë©”ì´ì…˜ */
        #progressFill {
            transition: width 0.5s ease-in-out;
        }

        /* ê´‘ê³  ë°°ë„ˆ ìŠ¤íƒ€ì¼ */
        #adBannerContainer {
            min-height: 60px;
            height: 60px;
        }

        #adBannerTrack {
            height: 100%;
        }

        .ad-item {
            min-width: 100%;
            flex-shrink: 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-50 h-dvh overflow-hidden flex flex-col">
    <!-- Main Container with Dynamic Viewport Height -->
    <div class="flex-1 overflow-y-auto">
        <div class="container-query max-w-4xl mx-auto p-4 sm:p-6 min-h-dvh flex flex-col">
            <!-- Header -->
            <header class="text-center mb-6 pt-4">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">Idiom Daily</h1>
                <p class="text-gray-600 container:text-sm">ë§¤ì¼ ë°°ìš°ëŠ” ì˜ì–´ ìˆ™ì–´</p>
            </header>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden bg-white rounded-xl shadow-sm p-6 border border-gray-200 text-center">
                <div class="text-gray-600">ìˆ™ì–´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>
                <div class="mt-3">
                    <div class="animate-spin inline-block w-6 h-6 border-4 border-current border-t-transparent text-gray-600 rounded-full"></div>
                </div>
            </div>

            <!-- Main Content Area -->
            <main class="flex-1 space-y-4">
                <!-- ì•ŒëŒ ì„¤ì • -->
                <section class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-200">
                    <h3 class="text-center font-semibold text-gray-700 mb-4">í•™ìŠµ ì•ŒëŒ ì„¤ì •</h3>
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
                        <input type="time" id="alarmTime" value="09:00" 
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 w-full sm:w-auto">
                        <button id="setAlarmBtn"
                            class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors w-full sm:w-auto">
                            ì•ŒëŒ ì„¤ì •
                        </button>
                        <button id="cancelAlarmBtn"
                            class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors w-full sm:w-auto">
                            ì•ŒëŒ í•´ì œ
                        </button>
                    </div>
                    <div id="alarmStatus" class="mt-4 text-center py-2 px-4 rounded-lg bg-gray-100 text-gray-600">
                        ì•ŒëŒì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
                    </div>
                </section>

                <!-- ë ˆë²¨ ì„ íƒ -->
                <section class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-200">
                    <h2 class="text-center text-lg sm:text-xl font-semibold text-gray-700 mb-4">í•™ìŠµ ë ˆë²¨ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                    <div class="grid grid-cols-1 @container:grid-cols-3 gap-3">
                        <button class="level-btn py-3 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium text-sm sm:text-base" 
                            data-level="beginner">
                            ì´ˆê¸‰
                        </button>
                        <button class="level-btn py-3 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium text-sm sm:text-base" 
                            data-level="intermediate">
                            ì¤‘ê¸‰
                        </button>
                        <button class="level-btn py-3 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium text-sm sm:text-base" 
                            data-level="advanced">
                            ê³ ê¸‰
                        </button>
                    </div>
                </section>

                <!-- í†µê³„ -->
                <section class="grid grid-cols-3 gap-2 sm:gap-3">
                    <div class="bg-white rounded-xl shadow-sm p-3 sm:p-4 border border-gray-200 text-center">
                        <div class="text-xl sm:text-2xl font-bold text-gray-700" id="streakCount">0</div>
                        <div class="text-xs sm:text-sm text-gray-500 mt-1">ì—°ì†ì¼</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-3 sm:p-4 border border-gray-200 text-center">
                        <div class="text-xl sm:text-2xl font-bold text-gray-700" id="totalLearned">0</div>
                        <div class="text-xs sm:text-sm text-gray-500 mt-1">í•™ìŠµ ìˆ™ì–´</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-3 sm:p-4 border border-gray-200 text-center">
                        <div class="text-xl sm:text-2xl font-bold text-gray-700" id="quizScore">0%</div>
                        <div class="text-xs sm:text-sm text-gray-500 mt-1">ì •ë‹µë¥ </div>
                    </div>
                </section>

                <!-- í•™ìŠµ ì„¹ì…˜ -->
                <section id="learningSection" class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-200 hidden">
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4 sm:mb-6 overflow-hidden">
                        <div class="bg-gray-600 h-full transition-all duration-500" id="progressFill" style="width: 0%"></div>
                    </div>

                    <!-- ìˆ™ì–´ ì¹´ë“œ -->
                    <div class="idiom-card text-center mb-4 sm:mb-6">
                        <div class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center justify-center gap-2 sm:gap-3 flex-wrap" id="idiomTitle">
                            ì˜¤ëŠ˜ì˜ ìˆ™ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”
                        </div>
                        <div class="text-base sm:text-lg text-gray-600 mb-2 sm:mb-3" id="idiomMeaning"></div>
                        <div class="text-sm sm:text-base text-gray-500 italic flex items-center justify-center gap-2 sm:gap-3 flex-wrap" id="idiomExample"></div>
                        
                        <!-- ìŒì„± ì¸ì‹ -->
                        <div id="voiceControls" class="mt-4 sm:mt-6 p-4 sm:p-6 bg-gray-50 rounded-lg hidden">
                            <div class="text-base sm:text-lg font-semibold text-gray-700 mb-3 sm:mb-4">ë°œìŒ ì—°ìŠµí•˜ê¸°</div>
                            <div class="bg-white p-3 sm:p-4 rounded-lg border border-gray-200">
                                <div class="text-sm sm:text-base text-gray-700 font-medium mb-3 sm:mb-4 p-2 sm:p-3 bg-gray-100 rounded" id="voiceTarget">
                                    ëª©í‘œ ë°œìŒ: ìˆ™ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”
                                </div>
                                <div class="flex justify-center gap-3 sm:gap-4 mb-3 sm:mb-4">
                                    <button id="listenBtn"
                                        class="w-12 h-12 sm:w-14 sm:h-14 bg-gray-600 text-white rounded-full hover:bg-gray-700 transition-colors flex items-center justify-center text-lg sm:text-xl">
                                        ğŸ¤
                                    </button>
                                    <button id="playTargetBtn"
                                        class="w-12 h-12 sm:w-14 sm:h-14 bg-gray-500 text-white rounded-full hover:bg-gray-600 transition-colors flex items-center justify-center text-lg sm:text-xl">
                                        ğŸ”Š
                                    </button>
                                </div>
                                <div class="text-sm sm:text-base text-gray-600 p-2 sm:p-3 bg-gray-50 rounded mb-2 sm:mb-3" id="recognitionResult">
                                    ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°œìŒì„ ì‹œì‘í•˜ì„¸ìš”
                                </div>
                                <div id="voiceFeedback" class="p-2 sm:p-3 rounded text-sm sm:text-base"></div>
                            </div>
                        </div>
                    </div>

                    <!-- í€´ì¦ˆ ì„¹ì…˜ -->
                    <div id="quizSection" class="hidden">
                        <div id="quizLearningContent" class="bg-gray-50 p-4 sm:p-6 rounded-lg mb-4 border-l-4 border-gray-600">
                            <h3 class="text-gray-700 font-semibold mb-2 sm:mb-3 text-sm sm:text-base">í•™ìŠµ ë‚´ìš© ë³µìŠµ</h3>
                            <div class="text-base sm:text-lg font-medium text-gray-800 mb-2" id="quizIdiomTitle"></div>
                            <div class="text-sm sm:text-base text-gray-600 mb-2" id="quizIdiomMeaning"></div>
                            <div class="text-sm sm:text-base text-gray-500 italic" id="quizIdiomExample"></div>
                            <button id="showQuizBtn"
                                class="mt-3 sm:mt-4 px-4 sm:px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors text-sm sm:text-base">
                                í€´ì¦ˆ í’€ì–´ë³´ê¸°
                            </button>
                        </div>
                        
                        <div id="actualQuiz" class="hidden">
                            <div class="p-3 sm:p-4 bg-gray-50 rounded-lg border-l-4 border-gray-600 mb-3 sm:mb-4 font-medium text-sm sm:text-base" id="quizQuestion"></div>
                            <div class="space-y-2 sm:space-y-3" id="quizOptions"></div>
                        </div>
                    </div>

                    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 justify-center mt-4 sm:mt-6">
                        <button id="startBtn"
                            class="px-4 sm:px-6 py-2 sm:py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium text-sm sm:text-base">
                            ë°œìŒ ì—°ìŠµí•˜ê¸°
                        </button>
                        <button id="nextBtn"
                            class="px-4 sm:px-6 py-2 sm:py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium text-sm sm:text-base hidden">
                            ë‹¤ìŒ
                        </button>
                        <button id="teacherBtn"
                            class="px-4 sm:px-6 py-2 sm:py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium text-sm sm:text-base hidden">
                            ê°•ì‚¬ ë³µìŠµ
                        </button>
                        <button id="retryBtn"
                            class="px-4 sm:px-6 py-2 sm:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm sm:text-base hidden">
                            ìƒˆ ìˆ™ì–´
                        </button>
                    </div>
                </section>

                <!-- ê°•ì‚¬ ì„¹ì…˜ -->
                <section id="teacherSection" class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-200 hidden">
                    <div class="text-center">
                        <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gray-200 rounded-full mx-auto mb-3 sm:mb-4 flex items-center justify-center text-2xl sm:text-3xl" id="teacherAvatar">
                            ğŸ‘¨â€ğŸ«
                        </div>
                        <div class="text-sm sm:text-base text-gray-700 leading-relaxed mb-4 sm:mb-6" id="teacherMessage"></div>
                        <button id="finishBtn"
                            class="px-4 sm:px-6 py-2 sm:py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium text-sm sm:text-base">
                            í•™ìŠµ ì™„ë£Œ
                        </button>
                    </div>
                </section>

                <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ -->
                <div id="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded hidden">
                    <strong>ì˜¤ë¥˜:</strong> <span id="errorText"></span>
                </div>
            </main>
            
            <!-- ê´‘ê³  ë¡¤ë§ ë°°ë„ˆ -->
            <section class="bg-white border-t border-gray-200 py-3">
                <div class="container mx-auto px-4">
                    <div class="text-xs text-gray-500 text-center mb-2">ê´‘ê³ </div>
                    <div id="adBannerContainer" class="overflow-hidden relative">
                        <div id="adBannerTrack" class="flex transition-transform duration-500 ease-in-out">
                            <!-- ê´‘ê³  ë°°ë„ˆë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- API í‚¤ ì„¤ì • ëª¨ë‹¬ (ê°œì„ ëœ ë²„ì „) -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 sm:p-8 w-full max-w-md mx-auto">
            <div class="text-xl sm:text-2xl font-bold text-gray-800 text-center mb-4">API í‚¤ ê´€ë¦¬</div>
            
            <!-- í˜„ì¬ ìƒíƒœ í‘œì‹œ -->
            <div id="apiKeyStatus" class="mb-4 p-3 rounded-lg border">
                <div class="text-sm font-medium text-gray-700 mb-1">í˜„ì¬ ìƒíƒœ</div>
                <div id="apiKeyStatusText" class="text-sm text-gray-600">API í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</div>
            </div>
            
            <div class="text-sm text-gray-600 text-center mb-6">
                Gemini API ì‚¬ìš©ì„ ìœ„í•´ ë³¸ì¸ì˜ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">
                    Google AI Studioì—ì„œ í‚¤ ë°œê¸‰
                </a>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API í‚¤</label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" placeholder="AIzaSy..." 
                            class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400">
                        <button type="button" id="toggleApiKeyVisibility" 
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            <span id="eyeIcon">ğŸ‘ï¸</span>
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</div>
                </div>
                
                <!-- í‚¤ ê´€ë¦¬ ë²„íŠ¼ë“¤ -->
                <div class="flex gap-2">
                    <button id="saveApiKeyBtn" 
                        class="flex-1 px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors">
                        ì €ì¥
                    </button>
                    <button id="deleteApiKeyBtn"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        ì‚­ì œ
                    </button>
                    <button id="testApiKeyBtn"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        í…ŒìŠ¤íŠ¸

                    </button>
                </div>
                
                <!-- í•˜ë‹¨ ë²„íŠ¼ë“¤ -->
                <div class="flex gap-3 pt-2 border-t">
                    <button id="skipApiKeyBtn"
                        class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        ê±´ë„ˆë›°ê¸°
                    </button>
                    <button id="closeApiKeyModalBtn"
                        class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
            
            <!-- í…ŒìŠ¤íŠ¸ ê²°ê³¼ -->
            <div id="apiKeyTestResult" class="mt-4 p-3 rounded-lg hidden">
                <div class="text-sm font-medium mb-1">í…ŒìŠ¤íŠ¸ ê²°ê³¼</div>
                <div id="apiKeyTestMessage" class="text-sm"></div>
            </div>
        </div>
    </div>
    <div id="alarmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 sm:p-8 w-full max-w-md mx-auto">
            <div class="text-4xl sm:text-5xl text-center mb-3 sm:mb-4">â°</div>
            <div class="text-xl sm:text-2xl font-bold text-gray-800 text-center mb-2 sm:mb-3">í•™ìŠµ ì‹œê°„ì…ë‹ˆë‹¤!</div>
            <div class="text-sm sm:text-base text-gray-600 text-center mb-4 sm:mb-6">ì˜¤ëŠ˜ì˜ ì˜ì–´ ìˆ™ì–´ë¥¼ ë°°ì›Œë³¼ê¹Œìš”?</div>
            <div class="flex flex-col gap-2 sm:gap-3">
                <button id="startAlarmLessonBtn"
                    class="px-4 sm:px-6 py-2 sm:py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium text-sm sm:text-base">
                    ì§€ê¸ˆ í•™ìŠµí•˜ê¸°
                </button>
                <button id="snoozeAlarmBtn"
                    class="px-4 sm:px-6 py-2 sm:py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm sm:text-base">
                    5ë¶„ í›„ ì•Œë¦¼
                </button>
                <button id="dismissAlarmBtn"
                    class="px-4 sm:px-6 py-2 sm:py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors text-sm sm:text-base">
                    ë‚˜ì¤‘ì— í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <script>
        // Tailwind CSS ê²½ê³  ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        (function() {
            const originalConsoleWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && args[0].includes && args[0].includes('should not be used in production')) {
                    return;
                }
                originalConsoleWarn.apply(console, args);
            };
        })();

        // ì „ì—­ ë³€ìˆ˜ë“¤
        let appState = {
            currentLevel: null,
            currentIdiom: null,
            currentStep: 0,
            stats: JSON.parse(localStorage.getItem('idiomStats') || '{"streak": 0, "total": 0, "correct": 0, "attempts": 0}'),
            alarmTimeout: null,
            recognition: null
        };

        // API ê¸°ë°˜ ìˆ™ì–´ ë°ì´í„°ë² ì´ìŠ¤
        const idiomDatabase = {
            beginner: [
                "break the ice", "piece of cake", "hit the books", "under the weather", 
                "once in a blue moon", "cost an arm and a leg", "break a leg", "hang in there",
                "it's raining cats and dogs", "when pigs fly", "don't cry over spilled milk", 
                "the early bird catches the worm", "bite the bullet", "kill two birds with one stone",
                "let the cat out of the bag"
            ],
            intermediate: [
                "burn the midnight oil", "spill the beans", "the ball is in your court",
                "cut to the chase", "hit the nail on the head", "jump on the bandwagon",
                "steal someone's thunder", "throw in the towel", "the last straw",
                "go the extra mile", "on cloud nine", "face the music", "cross that bridge when you come to it",
                "don't put all your eggs in one basket", "every cloud has a silver lining"
            ],
            advanced: [
                "beat around the bush", "the elephant in the room", "a blessing in disguise",
                "call it a day", "the best of both worlds", "speak of the devil",
                "see eye to eye", "hear it through the grapevine", "miss the boat",
                "sit on the fence", "the whole nine yards", "under the same roof",
                "actions speak louder than words", "better late than never", "don't judge a book by its cover"
            ]
        };

        // ìŒì„± í•©ì„± ì§€ì› í™•ì¸
        const speechSupported = 'speechSynthesis' in window;
        const recognitionSupported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getElement(id) {
            return document.getElementById(id);
        }

        function querySelector(selector) {
            return document.querySelector(selector);
        }

        function querySelectorAll(selector) {
            return document.querySelectorAll(selector);
        }

        function showElement(element) {
            if (typeof element === 'string') {
                element = getElement(element);
            }
            if (element) {
                element.classList.remove('hidden');
            }
        }

        function hideElement(element) {
            if (typeof element === 'string') {
                element = getElement(element);
            }
            if (element) {
                element.classList.add('hidden');
            }
        }

        // ìŒì„± ì¸ì‹ ì´ˆê¸°í™”
        function initSpeechRecognition() {
            if (recognitionSupported) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                appState.recognition = new SpeechRecognition();
                appState.recognition.continuous = false;
                appState.recognition.interimResults = false;
                appState.recognition.lang = 'en-US';
            }
        }

        // APIì—ì„œ ìˆ™ì–´ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (Gemini API ì‚¬ìš©)
        async function fetchIdiomData(idiom) {
            showElement('loadingIndicator');
            
            try {
                // ë¨¼ì € Free Dictionary APIë¡œ ê¸°ë³¸ ì •ë³´ ì‹œë„
                const dictionaryResponse = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(idiom)}`);
                let meaning = '';
                let example = '';
                
                if (dictionaryResponse.ok) {
                    const data = await dictionaryResponse.json();
                    if (data && data.length > 0) {
                        const entry = data[0];
                        meaning = entry.meanings?.[0]?.definitions?.[0]?.definition || '';
                        example = entry.meanings?.[0]?.definitions?.[0]?.example || '';
                    }
                }
                
                // Gemini APIë¡œ í€´ì¦ˆ ìƒì„± ë° ë³´ì™„
                const geminiData = await generateIdiomDataWithGemini(idiom, meaning, example);
                
                return {
                    idiom: idiom,
                    meaning: geminiData.meaning || meaning || 'ì˜ë¯¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
                    example: geminiData.example || example || `"${idiom}"ì˜ ì‚¬ìš© ì˜ˆì‹œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`,
                    quiz: geminiData.quiz
                };
                
            } catch (error) {
                console.error('API ì˜¤ë¥˜:', error);
                return getFallbackIdiomData(idiom);
            } finally {
                hideElement('loadingIndicator');
            }
        }

        // ì¿ í‚¤ ê¸°ë°˜ ë³´ì•ˆ API í‚¤ ê´€ë¦¬ ì‹œìŠ¤í…œ
        class SecureCookieApiKeyManager {
            constructor() {
                this.cookieName = 'gemini_api_key';
                this.cookieOptions = {
                    expires: 30, // 30ì¼
                    secure: window.location.protocol === 'https:', // HTTPSì—ì„œë§Œ secure
                    sameSite: 'strict', // CSRF ë°©ì§€
                    path: '/' // ì „ì²´ ì‚¬ì´íŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥
                };
                this.encryptionKey = this.generateDeviceKey();
            }

            // ë””ë°”ì´ìŠ¤ë³„ ê³ ìœ  í‚¤ ìƒì„±
            generateDeviceKey() {
                const deviceInfo = [
                    navigator.userAgent,
                    navigator.language,
                    screen.width + 'x' + screen.height,
                    new Date().getTimezoneOffset(),
                    navigator.hardwareConcurrency || 'unknown'
                ].join('|');
                
                return this.simpleHash(deviceInfo);
            }

            // ê°„ë‹¨í•œ í•´ì‹œ í•¨ìˆ˜
            simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // 32bit ì •ìˆ˜ë¡œ ë³€í™˜
                }
                return Math.abs(hash).toString();
            }

            // ì¿ í‚¤ ê´€ë¦¬ ìœ í‹¸ë¦¬í‹° (js-cookie íŒ¨í„´ ì°¸ê³ , ìˆ˜ì •ëœ ë²„ì „)
            setCookie(name, value, options = {}) {
                const finalOptions = { ...this.cookieOptions, ...options };
                
                let cookieString = `${encodeURIComponent(name)}=${encodeURIComponent(value)}`;
                
                // ë§Œë£Œì¼ ì„¤ì • (ì¤‘ìš”: ëª…ì‹œì  ë§Œë£Œì¼ì´ ì—†ìœ¼ë©´ ì„¸ì…˜ ì¿ í‚¤ê°€ ë¨)
                if (finalOptions.expires) {
                    let expirationDate;
                    
                    if (typeof finalOptions.expires === 'number') {
                        // ìˆ«ìì¸ ê²½ìš° ì¼ìˆ˜ë¡œ ê³„ì‚°
                        expirationDate = new Date();
                        expirationDate.setTime(expirationDate.getTime() + finalOptions.expires * 24 * 60 * 60 * 1000);
                    } else if (finalOptions.expires instanceof Date) {
                        // Date ê°ì²´ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚¬ìš©
                        expirationDate = finalOptions.expires;
                    }
                    
                    if (expirationDate) {
                        cookieString += `; expires=${expirationDate.toUTCString()}`;
                        console.log(`ì¿ í‚¤ ë§Œë£Œì¼ ì„¤ì •: ${expirationDate.toUTCString()}`);
                    }
                } else {
                    // ë§Œë£Œì¼ì´ ì—†ìœ¼ë©´ ì˜êµ¬ ì¿ í‚¤ë¡œ ì„¤ì • (ë§¤ìš° ë¨¼ ë¯¸ë˜ ë‚ ì§œ)
                    const farFuture = new Date();
                    farFuture.setFullYear(farFuture.getFullYear() + 1); // 1ë…„ í›„
                    cookieString += `; expires=${farFuture.toUTCString()}`;
                    console.log(`ê¸°ë³¸ ë§Œë£Œì¼ ì„¤ì •: ${farFuture.toUTCString()}`);
                }
                
                if (finalOptions.path) {
                    cookieString += `; path=${finalOptions.path}`;
                }
                
                if (finalOptions.domain) {
                    cookieString += `; domain=${finalOptions.domain}`;
                }
                
                if (finalOptions.secure) {
                    cookieString += `; secure`;
                }
                
                if (finalOptions.sameSite) {
                    cookieString += `; samesite=${finalOptions.sameSite}`;
                }
                
                // ì‹¤ì œ ì¿ í‚¤ ì„¤ì •
                document.cookie = cookieString;
                
                // ì„¤ì • í™•ì¸
                console.log(`ì¿ í‚¤ ì„¤ì •: ${cookieString}`);
                
                // ì„¤ì • í›„ ì¦‰ì‹œ í™•ì¸
                setTimeout(() => {
                    const savedValue = this.getCookie(name);
                    console.log(`ì¿ í‚¤ ì €ì¥ í™•ì¸: ${name} = ${savedValue ? 'ì €ì¥ë¨' : 'ì‹¤íŒ¨'}`);
                }, 100);
            }

            getCookie(name) {
                const encodedName = encodeURIComponent(name);
                const cookies = document.cookie.split(';');
                
                for (let cookie of cookies) {
                    let [cookieName, cookieValue] = cookie.trim().split('=');
                    if (cookieName === encodedName) {
                        return decodeURIComponent(cookieValue);
                    }
                }
                return null;
            }

            removeCookie(name, options = {}) {
                const finalOptions = { ...this.cookieOptions, ...options, expires: -1 };
                this.setCookie(name, '', finalOptions);
            }

            // XOR ì•”í˜¸í™”/ë³µí˜¸í™” (ë””ë°”ì´ìŠ¤ë³„ í‚¤ ì‚¬ìš©)
            encrypt(text) {
                const keyBytes = this.stringToBytes(this.encryptionKey);
                const textBytes = this.stringToBytes(text);
                const encrypted = [];
                
                for (let i = 0; i < textBytes.length; i++) {
                    encrypted.push(textBytes[i] ^ keyBytes[i % keyBytes.length]);
                }
                
                return btoa(String.fromCharCode(...encrypted));
            }

            decrypt(encryptedText) {
                try {
                    const keyBytes = this.stringToBytes(this.encryptionKey);
                    const encryptedBytes = [...atob(encryptedText)].map(char => char.charCodeAt(0));
                    const decrypted = [];
                    
                    for (let i = 0; i < encryptedBytes.length; i++) {
                        decrypted.push(encryptedBytes[i] ^ keyBytes[i % keyBytes.length]);
                    }
                    
                    return String.fromCharCode(...decrypted);
                } catch (error) {
                    console.error('ë³µí˜¸í™” ì‹¤íŒ¨:', error);
                    return null;
                }
            }

            stringToBytes(str) {
                return [...str].map(char => char.charCodeAt(0));
            }

            // API í‚¤ ì„¤ì •
            setApiKey(apiKey) {
                if (!apiKey || !this.validateApiKey(apiKey)) {
                    throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ API í‚¤ì…ë‹ˆë‹¤');
                }

                try {
                    const encryptedKey = this.encrypt(apiKey);
                    this.setCookie(this.cookieName, encryptedKey);
                    
                    // ì„¤ì • í™•ì¸ì„ ìœ„í•œ í•´ì‹œë„ ì €ì¥
                    const keyHash = this.simpleHash(apiKey);
                    this.setCookie(this.cookieName + '_hash', keyHash);
                    
                    console.log('API í‚¤ê°€ ì•ˆì „í•˜ê²Œ ì¿ í‚¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                    return true;
                } catch (error) {
                    console.error('API í‚¤ ì €ì¥ ì‹¤íŒ¨:', error);
                    throw new Error('API í‚¤ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            }

            // API í‚¤ ê°€ì ¸ì˜¤ê¸°
            getApiKey() {
                try {
                    const encryptedKey = this.getCookie(this.cookieName);
                    if (!encryptedKey) {
                        return null;
                    }
                    
                    const decryptedKey = this.decrypt(encryptedKey);
                    
                    // ë¬´ê²°ì„± ê²€ì¦
                    if (decryptedKey && this.validateApiKey(decryptedKey)) {
                        const expectedHash = this.simpleHash(decryptedKey);
                        const storedHash = this.getCookie(this.cookieName + '_hash');
                        
                        if (expectedHash === storedHash) {
                            return decryptedKey;
                        } else {
                            console.warn('API í‚¤ ë¬´ê²°ì„± ê²€ì¦ ì‹¤íŒ¨');
                            this.clearApiKey();
                            return null;
                        }
                    }
                    
                    return null;
                } catch (error) {
                    console.error('API í‚¤ ë³µí˜¸í™” ì‹¤íŒ¨:', error);
                    this.clearApiKey(); // ì†ìƒëœ ë°ì´í„° ì •ë¦¬
                    return null;
                }
            }

            // API í‚¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            hasApiKey() {
                const encryptedKey = this.getCookie(this.cookieName);
                const hash = this.getCookie(this.cookieName + '_hash');
                return !!(encryptedKey && hash);
            }

            // API í‚¤ ì‚­ì œ
            clearApiKey() {
                this.removeCookie(this.cookieName);
                this.removeCookie(this.cookieName + '_hash');
                console.log('API í‚¤ê°€ ì¿ í‚¤ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            }

            // API í‚¤ ìœ íš¨ì„± ê²€ì‚¬
            validateApiKey(apiKey) {
                return apiKey && 
                       typeof apiKey === 'string' && 
                       apiKey.startsWith('AIzaSy') && 
                       apiKey.length >= 35;
            }

            // ì¿ í‚¤ ë§Œë£Œì¼ ê°±ì‹ 
            refreshExpiry() {
                const currentKey = this.getApiKey();
                if (currentKey) {
                    this.setApiKey(currentKey); // ë§Œë£Œì¼ì´ ê°±ì‹ ë¨
                    console.log('ì¿ í‚¤ ë§Œë£Œì¼ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            }

            // ë””ë°”ì´ìŠ¤ ì •ë³´ í™•ì¸
            getDeviceInfo() {
                return {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    screen: screen.width + 'x' + screen.height,
                    timezone: new Date().getTimezoneOffset(),
                    cores: navigator.hardwareConcurrency || 'unknown',
                    deviceKey: this.encryptionKey
                };
            }

            // ë³´ì•ˆ ìƒíƒœ ì ê²€
            getSecurityStatus() {
                return {
                    hasApiKey: this.hasApiKey(),
                    isSecure: window.location.protocol === 'https:',
                    cookieSupported: navigator.cookieEnabled,
                    sameSiteSupported: 'sameSite' in Document.prototype,
                    deviceKeyGenerated: !!this.encryptionKey,
                    encryptionMethod: 'XOR with device-specific key'
                };
            }

            // ëª¨ë“  ê´€ë ¨ ì¿ í‚¤ ëª©ë¡
            getAllRelatedCookies() {
                const cookies = document.cookie.split(';');
                const related = [];
                
                for (let cookie of cookies) {
                    const [name] = cookie.trim().split('=');
                    const decodedName = decodeURIComponent(name);
                    if (decodedName.includes('gemini') || decodedName.includes('api_key')) {
                        related.push(decodedName);
                    }
                }
                
                return related;
            }

            // ë³´ì•ˆ ì •ë¦¬ (ê°œë°œìš©)
            securityCleanup() {
                const relatedCookies = this.getAllRelatedCookies();
                relatedCookies.forEach(cookieName => {
                    this.removeCookie(cookieName);
                });
                console.log('ëª¨ë“  ê´€ë ¨ ì¿ í‚¤ê°€ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤:', relatedCookies);
            }
        }

        // ì¿ í‚¤ ê¸°ë°˜ API í‚¤ ê´€ë¦¬ì ì¸ìŠ¤í„´ìŠ¤
        const apiKeyManager = new SecureCookieApiKeyManager();

        // Gemini APIë¥¼ ì‚¬ìš©í•œ ìˆ™ì–´ ë°ì´í„° ìƒì„± (ë³´ì•ˆ ê°•í™”)
        async function generateIdiomDataWithGemini(idiom, existingMeaning = '', existingExample = '') {
            const apiKey = apiKeyManager.getApiKey();
            
            if (!apiKey) {
                throw new Error('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
            }

            const prompt = `
            ì˜ì–´ ìˆ™ì–´ "${idiom}"ì— ëŒ€í•œ ì •ë³´ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.
            
            ${existingMeaning ? `ê¸°ì¡´ ì˜ë¯¸: ${existingMeaning}` : ''}
            ${existingExample ? `ê¸°ì¡´ ì˜ˆë¬¸: ${existingExample}` : ''}
            
            ë‹¤ìŒ í˜•ì‹ì˜ JSONìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
            {
                "meaning": "í•œêµ­ì–´ ì˜ë¯¸ (ê°„ë‹¨ëª…ë£Œí•˜ê²Œ)",
                "example": "ì˜ì–´ ì˜ˆë¬¸ (ì‹¤ìš©ì ì´ê³  ìì—°ìŠ¤ëŸ½ê²Œ)",
                "quiz": {
                    "question": "ë‹¤ìŒ ì¤‘ '${idiom}'ì˜ ì˜ë¯¸ëŠ”?",
                    "options": ["ì •ë‹µ", "ì˜¤ë‹µ1", "ì˜¤ë‹µ2", "ì˜¤ë‹µ3"],
                    "correct": 0
                }
            }
            
            í€´ì¦ˆì˜ ì˜¤ë‹µì€ ê·¸ëŸ´ë“¯í•˜ì§€ë§Œ í‹€ë¦° ì„ íƒì§€ë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
            `;

            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-goog-api-key': apiKey
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    if (response.status === 400) {
                        throw new Error('API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    }
                    throw new Error(`Gemini API ì˜¤ë¥˜: ${response.status}`);
                }

                const data = await response.json();
                const generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    try {
                        const cleanedText = generatedText.replace(/```json\n?|\n?```/g, '').trim();
                        const parsedData = JSON.parse(cleanedText);
                        
                        if (parsedData.meaning && parsedData.example && parsedData.quiz) {
                            return parsedData;
                        }
                    } catch (parseError) {
                        console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', parseError);
                        return extractDataFromText(generatedText, idiom);
                    }
                }
                
                throw new Error('Gemini API ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
                
            } catch (error) {
                console.error('Gemini API ì˜¤ë¥˜:', error);
                
                if (error.message.includes('API í‚¤')) {
                    // API í‚¤ ì˜¤ë¥˜ ì‹œ í‚¤ ì¬ì„¤ì • ìš”ì²­
                    apiKeyManager.clearApiKey();
                    showApiKeyModal();
                    throw error;
                }
                
                return generateFallbackQuiz(idiom, existingMeaning, existingExample);
            }
        }

        // API í‚¤ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ (ê°œì„ ëœ ë²„ì „)
        function showApiKeyModal() {
            const modal = getElement('apiKeyModal');
            if (modal) {
                // í˜„ì¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                updateApiKeyStatus();
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
                const input = getElement('apiKeyInput');
                if (input) {
                    setTimeout(() => input.focus(), 100);
                }
            }
        }

        function hideApiKeyModal() {
            const modal = getElement('apiKeyModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                const input = getElement('apiKeyInput');
                if (input) {
                    input.value = '';
                    input.type = 'password';
                }
                
                // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìˆ¨ê¸°ê¸°
                hideApiKeyTestResult();
            }
        }

        // API í‚¤ ìƒíƒœ ê´€ë¦¬ ì‹œìŠ¤í…œ (Context7 ë°˜ì‘í˜• íŒ¨í„´ ì ìš©)
        class ApiKeyStateManager extends EventTarget {
            constructor() {
                super();
                this._hasApiKey = false;
                this.updateState();
            }

            // í˜„ì¬ ìƒíƒœ í™•ì¸ ë° ì—…ë°ì´íŠ¸
            updateState() {
                const previousState = this._hasApiKey;
                this._hasApiKey = apiKeyManager.hasApiKey();
                
                if (previousState !== this._hasApiKey) {
                    console.log(`API í‚¤ ìƒíƒœ ë³€ê²½: ${previousState} -> ${this._hasApiKey}`);
                    this.dispatchEvent(new CustomEvent('apikey-state-changed', {
                        detail: { hasApiKey: this._hasApiKey }
                    }));
                }
            }

            get hasApiKey() {
                return this._hasApiKey;
            }

            // ìƒíƒœ ë³€ê²½ ê°ì§€ìš© í´ë§ ì‹œì‘
            startPolling() {
                setInterval(() => {
                    this.updateState();
                }, 1000); // 1ì´ˆë§ˆë‹¤ í™•ì¸
            }
        }

        // ì „ì—­ ìƒíƒœ ê´€ë¦¬ì
        const apiKeyState = new ApiKeyStateManager();

        // API í‚¤ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ (ê°œì„ ëœ ìƒíƒœ ë°˜ì˜ ë²„ì „)
        function showApiKeyModal() {
            const modal = getElement('apiKeyModal');
            if (modal) {
                // ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                apiKeyState.updateState();
                updateApiKeyStatus();
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
                const input = getElement('apiKeyInput');
                if (input) {
                    setTimeout(() => input.focus(), 100);
                }
                
                console.log('API í‚¤ ëª¨ë‹¬ ì—´ë¦¼ - í˜„ì¬ ìƒíƒœ:', apiKeyState.hasApiKey);
            }
        }

        function updateApiKeyStatus() {
            const statusContainer = getElement('apiKeyStatus');
            const statusText = getElement('apiKeyStatusText');
            const deleteBtn = getElement('deleteApiKeyBtn');
            
            if (!statusContainer || !statusText || !deleteBtn) return;

            // ì‹¤ì‹œê°„ ìƒíƒœ í™•ì¸
            const hasKey = apiKeyManager.hasApiKey();
            const actualKey = apiKeyManager.getApiKey();
            const securityStatus = apiKeyManager.getSecurityStatus();
            
            console.log('ìƒíƒœ ì—…ë°ì´íŠ¸:', { hasKey, hasActualKey: !!actualKey });
            
            if (hasKey && actualKey) {
                statusContainer.className = 'mb-4 p-3 rounded-lg border border-green-200 bg-green-50';
                statusText.className = 'text-sm text-green-700';
                statusText.innerHTML = `
                    <div class="font-medium flex items-center gap-2">
                        <span class="text-green-600">âœ“</span>
                        API í‚¤ê°€ ì¿ í‚¤ì— ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤
                    </div>
                    <div class="text-xs mt-1 space-y-1">
                        <div>â€¢ ë³´ì•ˆ: ${securityStatus.isSecure ? 'HTTPS ì—°ê²°' : 'HTTP ì—°ê²° (ë¹„ë³´ì•ˆ)'}</div>
                        <div>â€¢ ì €ì¥ì†Œ: ì•”í˜¸í™”ëœ ì¿ í‚¤ (ë””ë°”ì´ìŠ¤ë³„)</div>
                        <div>â€¢ ë§Œë£Œ: 30ì¼ í›„ ìë™ ì‚­ì œ</div>
                        <div>â€¢ ê³ ê¸‰ í€´ì¦ˆ: <span class="font-medium text-green-600">ì‚¬ìš© ê°€ëŠ¥</span></div>
                    </div>
                `;
                deleteBtn.disabled = false;
                deleteBtn.className = 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors';
            } else {
                statusContainer.className = 'mb-4 p-3 rounded-lg border border-gray-200 bg-gray-50';
                statusText.className = 'text-sm text-gray-600';
                statusText.innerHTML = `
                    <div class="font-medium flex items-center gap-2">
                        <span class="text-gray-400">â—‹</span>
                        API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
                    </div>
                    <div class="text-xs mt-1 space-y-1">
                        <div>â€¢ ì¿ í‚¤ ì§€ì›: ${securityStatus.cookieSupported ? 'ì§€ì›ë¨' : 'ì§€ì›ì•ˆë¨'}</div>
                        <div>â€¢ ë³´ì•ˆ ëª¨ë“œ: ${securityStatus.isSecure ? 'HTTPS' : 'HTTP'}</div>
                        <div>â€¢ ê³ ê¸‰ í€´ì¦ˆ: <span class="font-medium text-gray-500">ì‚¬ìš© ë¶ˆê°€</span></div>
                    </div>
                `;
                deleteBtn.disabled = true;
                deleteBtn.className = 'px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed';
            }
        }

        function saveApiKey() {
            const input = getElement('apiKeyInput');
            const apiKey = input ? input.value.trim() : '';
            
            if (!apiKey) {
                showApiKeyTestResult('ì˜¤ë¥˜', 'API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                if (apiKeyManager.setApiKey(apiKey)) {
                    showApiKeyTestResult('ì„±ê³µ', 'ì¿ í‚¤ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (30ì¼ ìœ íš¨)', 'success');
                    
                    // ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    setTimeout(() => {
                        apiKeyState.updateState();
                        updateApiKeyStatus();
                    }, 500);
                    
                    // ì…ë ¥ í•„ë“œ í´ë¦¬ì–´
                    if (input) {
                        input.value = '';
                    }
                    
                    console.log('API í‚¤ ì €ì¥ ì™„ë£Œ ë° ìƒíƒœ ì—…ë°ì´íŠ¸');
                }
            } catch (error) {
                showApiKeyTestResult('ì˜¤ë¥˜', error.message, 'error');
            }
        }

        function deleteApiKey() {
            const confirmMessage = `ì •ë§ë¡œ API í‚¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?

ì‚­ì œ í›„ ë³€ê²½ì‚¬í•­:
â€¢ ì¿ í‚¤ì—ì„œ ì™„ì „íˆ ì œê±°ë©ë‹ˆë‹¤
â€¢ ê³ ê¸‰ í€´ì¦ˆ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤
â€¢ ê¸°ë³¸ í€´ì¦ˆë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤

ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;

            if (confirm(confirmMessage)) {
                apiKeyManager.clearApiKey();
                showApiKeyTestResult('ì™„ë£Œ', 'ì¿ í‚¤ì—ì„œ API í‚¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                
                // ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    apiKeyState.updateState();
                    updateApiKeyStatus();
                }, 500);
                
                // ì…ë ¥ í•„ë“œ í´ë¦¬ì–´
                const input = getElement('apiKeyInput');
                if (input) {
                    input.value = '';
                }
                
                console.log('API í‚¤ ì‚­ì œ ì™„ë£Œ ë° ìƒíƒœ ì—…ë°ì´íŠ¸');
            }
        }

        // ì¿ í‚¤ ê´€ë¦¬ í¸ì˜ í•¨ìˆ˜ë“¤ (ê°œë°œì ì½˜ì†”ìš©, ê°œì„ ëœ ë²„ì „)
        function getCookieInfo() {
            const info = {
                hasApiKey: apiKeyManager.hasApiKey(),
                deviceInfo: apiKeyManager.getDeviceInfo(),
                securityStatus: apiKeyManager.getSecurityStatus(),
                relatedCookies: apiKeyManager.getAllRelatedCookies(),
                cookieExpiry: '30ì¼',
                allCookies: document.cookie.split(';').map(c => c.trim()),
                cookieEnabled: navigator.cookieEnabled
            };
            
            console.log('=== ì¿ í‚¤ ìƒíƒœ ì •ë³´ ===');
            console.log('API í‚¤ ì¡´ì¬:', info.hasApiKey);
            console.log('ì¿ í‚¤ ì§€ì›:', info.cookieEnabled);
            console.log('ë³´ì•ˆ ìƒíƒœ:', info.securityStatus);
            console.log('ëª¨ë“  ì¿ í‚¤:', info.allCookies);
            
            return info;
        }

        function debugCookieStorage() {
            console.log('=== ì¿ í‚¤ ì €ì¥ ë””ë²„ê¹… ===');
            
            // í…ŒìŠ¤íŠ¸ ì¿ í‚¤ ìƒì„±
            const testValue = 'test_' + Date.now();
            apiKeyManager.setCookie('debug_test', testValue, { expires: 1 });
            
            // ì¦‰ì‹œ ì½ê¸° í…ŒìŠ¤íŠ¸
            const readValue = apiKeyManager.getCookie('debug_test');
            console.log('í…ŒìŠ¤íŠ¸ ì¿ í‚¤ ì €ì¥/ì½ê¸°:', readValue === testValue ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');
            
            // ë¸Œë¼ìš°ì € ì¬ì‹œì‘ ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ ì •ë³´
            console.log('ë¸Œë¼ìš°ì € ì¬ì‹œì‘ í›„ í™•ì¸í•˜ë ¤ë©´:');
            console.log('1. ë¸Œë¼ìš°ì €ë¥¼ ì™„ì „íˆ ì¢…ë£Œ');
            console.log('2. ë‹¤ì‹œ ì—´ì–´ì„œ ê°œë°œì ì½˜ì†”ì—ì„œ getCookieInfo() ì‹¤í–‰');
            
            // í˜„ì¬ ì¿ í‚¤ ìƒíƒœ í‘œì‹œ
            console.log('í˜„ì¬ ëª¨ë“  ì¿ í‚¤:', document.cookie);
            
            // í…ŒìŠ¤íŠ¸ ì¿ í‚¤ ì •ë¦¬
            setTimeout(() => {
                apiKeyManager.removeCookie('debug_test');
                console.log('í…ŒìŠ¤íŠ¸ ì¿ í‚¤ ì •ë¦¬ ì™„ë£Œ');
            }, 5000);
        }

        function refreshCookieExpiry() {
            const currentKey = apiKeyManager.getApiKey();
            if (currentKey) {
                apiKeyManager.setApiKey(currentKey); // ë§Œë£Œì¼ì´ ê°±ì‹ ë¨
                console.log('ì¿ í‚¤ ë§Œë£Œì¼ì´ 30ì¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤');
                
                // ê°±ì‹  í™•ì¸
                setTimeout(() => {
                    const stillExists = apiKeyManager.hasApiKey();
                    console.log('ë§Œë£Œì¼ ê°±ì‹  í™•ì¸:', stillExists ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');
                }, 1000);
            } else {
                console.log('ê°±ì‹ í•  API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤');
            }
        }

        function clearAllApiCookies() {
            if (confirm('ê°œë°œìš©: ëª¨ë“  API ê´€ë ¨ ì¿ í‚¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const beforeCount = apiKeyManager.getAllRelatedCookies().length;
                apiKeyManager.securityCleanup();
                
                setTimeout(() => {
                    const afterCount = apiKeyManager.getAllRelatedCookies().length;
                    console.log(`ì¿ í‚¤ ì •ë¦¬ ì™„ë£Œ: ${beforeCount}ê°œ -> ${afterCount}ê°œ`);
                }, 1000);
            }
        }

        // ì¿ í‚¤ ë¬¸ì œ í•´ê²° ê°€ì´ë“œ
        function cookieTroubleshooting() {
            console.log('=== ì¿ í‚¤ ë¬¸ì œ í•´ê²° ê°€ì´ë“œ ===');
            
            const issues = [];
            
            // ì¿ í‚¤ ì§€ì› í™•ì¸
            if (!navigator.cookieEnabled) {
                issues.push('âŒ ë¸Œë¼ìš°ì €ì—ì„œ ì¿ í‚¤ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤');
            } else {
                console.log('âœ… ì¿ í‚¤ ì§€ì›: í™œì„±í™”ë¨');
            }
            
            // HTTPS í™•ì¸
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                issues.push('âš ï¸ HTTPSê°€ ì•„ë‹Œ í™˜ê²½ì…ë‹ˆë‹¤. ë³´ì•ˆ ì¿ í‚¤ê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
            } else {
                console.log('âœ… ë³´ì•ˆ ì—°ê²°: ì •ìƒ');
            }
            
            // í”„ë¼ì´ë¹— ëª¨ë“œ ê°ì§€ ì‹œë„
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                console.log('âœ… ìŠ¤í† ë¦¬ì§€ ì ‘ê·¼: ì •ìƒ');
            } catch (e) {
                issues.push('âš ï¸ í”„ë¼ì´ë¹— ë¸Œë¼ìš°ì§• ëª¨ë“œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤');
            }
            
            // ì¿ í‚¤ í¬ê¸° í™•ì¸
            const allCookies = document.cookie;
            if (allCookies.length > 4000) {
                issues.push('âš ï¸ ì¿ í‚¤ í¬ê¸°ê°€ í½ë‹ˆë‹¤. ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
            }
            
            if (issues.length === 0) {
                console.log('âœ… ì¿ í‚¤ í™˜ê²½: ì •ìƒ');
                console.log('ë¸Œë¼ìš°ì € ì¬ì‹œì‘ í›„ì—ë„ ì¿ í‚¤ê°€ ìœ ì§€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤');
            } else {
                console.log('ë°œê²¬ëœ ë¬¸ì œì ë“¤:');
                issues.forEach(issue => console.log(issue));
            }
            
            return {
                cookieEnabled: navigator.cookieEnabled,
                isSecure: window.location.protocol === 'https:',
                cookieSize: allCookies.length,
                issues: issues
            };
        }

        async function testApiKey() {
            const input = getElement('apiKeyInput');
            const apiKey = input ? input.value.trim() : '';
            
            if (!apiKey) {
                showApiKeyTestResult('ì˜¤ë¥˜', 'í…ŒìŠ¤íŠ¸í•  API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            showApiKeyTestResult('í…ŒìŠ¤íŠ¸ ì¤‘', 'API í‚¤ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'loading');

            try {
                // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ìš”ì²­
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-goog-api-key': apiKey
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: 'Hello'
                            }]
                        }]
                    })
                });

                if (response.ok) {
                    showApiKeyTestResult('ì„±ê³µ', 'API í‚¤ê°€ ìœ íš¨í•©ë‹ˆë‹¤! ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.', 'success');
                } else if (response.status === 400) {
                    showApiKeyTestResult('ì˜¤ë¥˜', 'API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                } else if (response.status === 429) {
                    showApiKeyTestResult('ê²½ê³ ', 'API ì‚¬ìš©ëŸ‰ í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                } else {
                    showApiKeyTestResult('ì˜¤ë¥˜', `API ì˜¤ë¥˜ (${response.status}): ì„œë²„ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.`, 'error');
                }
            } catch (error) {
                showApiKeyTestResult('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
            }
        }

        function showApiKeyTestResult(title, message, type) {
            const resultContainer = getElement('apiKeyTestResult');
            const messageElement = getElement('apiKeyTestMessage');
            
            if (!resultContainer || !messageElement) return;

            const typeStyles = {
                success: 'border-green-200 bg-green-50 text-green-800',
                error: 'border-red-200 bg-red-50 text-red-800',
                warning: 'border-yellow-200 bg-yellow-50 text-yellow-800',
                info: 'border-blue-200 bg-blue-50 text-blue-800',
                loading: 'border-gray-200 bg-gray-50 text-gray-800'
            };

            resultContainer.className = `mt-4 p-3 rounded-lg border ${typeStyles[type] || typeStyles.info}`;
            messageElement.innerHTML = `<strong>${title}:</strong> ${message}`;
            resultContainer.classList.remove('hidden');

            // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€ (ë¡œë”© ìƒíƒœê°€ ì•„ë‹Œ ê²½ìš°)
            if (type !== 'loading') {
                setTimeout(() => {
                    hideApiKeyTestResult();
                }, 5000);
            }
        }

        function hideApiKeyTestResult() {
            const resultContainer = getElement('apiKeyTestResult');
            if (resultContainer) {
                resultContainer.classList.add('hidden');
            }
        }

        function toggleApiKeyVisibility() {
            const input = getElement('apiKeyInput');
            const eyeIcon = getElement('eyeIcon');
            
            if (!input || !eyeIcon) return;

            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                eyeIcon.textContent = 'ğŸ‘ï¸';
            }
        }

        function skipApiKey() {
            hideApiKeyModal();
            showError('API í‚¤ ì—†ì´ëŠ” ê³ ê¸‰ í€´ì¦ˆ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ í€´ì¦ˆë¡œ ì§„í–‰ë©ë‹ˆë‹¤.');
        }

        // API í‚¤ ê´€ë¦¬ ì„¤ì • ì—´ê¸° (ë©”ë‰´ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
        function openApiKeySettings() {
            showApiKeyModal();
        }

        // ì•± ì‹œì‘ ì‹œ API í‚¤ í™•ì¸
        function checkApiKeyOnStartup() {
            if (!apiKeyManager.hasApiKey()) {
                // ì²« ë°©ë¬¸ì´ê±°ë‚˜ ì„¸ì…˜ì´ ë§Œë£Œëœ ê²½ìš°
                setTimeout(() => {
                    showApiKeyModal();
                }, 1000); // 1ì´ˆ í›„ ëª¨ë‹¬ í‘œì‹œ
            }
        }

        // ê´‘ê³  ë¡¤ë§ ë°°ë„ˆ ì‹œìŠ¤í…œ (ìˆ˜ì •ëœ ë²„ì „)
        class AdBannerManager {
            constructor() {
                this.ads = [];
                this.currentIndex = 0;
                this.intervalId = null;
                this.container = null;
                this.track = null;
                this.isPlaying = false;
                this.animationDuration = 500;
                this.displayDuration = 3000;
                this.isInitialized = false;
                
                // ê¸°ë³¸ ê´‘ê³  ë°ì´í„°
                this.defaultAds = [
                    {
                        id: 1,
                        title: "ì˜¨ë¼ì¸ ì˜ì–´ ê³¼ì™¸",
                        description: "ì›ì–´ë¯¼ê³¼ 1:1 ì˜ì–´ íšŒí™” ìˆ˜ì—…",
                        link: "#",
                        bgColor: "bg-blue-50",
                        textColor: "text-blue-800",
                        buttonColor: "bg-blue-600 hover:bg-blue-700"
                    },
                    {
                        id: 2,
                        title: "ì˜ì–´ í•™ìŠµ ì•±",
                        description: "AI ê¸°ë°˜ ë§ì¶¤í˜• ì˜ì–´ í•™ìŠµ",
                        link: "#",
                        bgColor: "bg-green-50",
                        textColor: "text-green-800",
                        buttonColor: "bg-green-600 hover:bg-green-700"
                    },
                    {
                        id: 3,
                        title: "í† ìµ ê°•ì˜",
                        description: "ë‹¨ê¸°ê°„ ì ìˆ˜ í–¥ìƒ ë³´ì¥",
                        link: "#",
                        bgColor: "bg-purple-50",
                        textColor: "text-purple-800",
                        buttonColor: "bg-purple-600 hover:bg-purple-700"
                    },
                    {
                        id: 4,
                        title: "ì˜ë¬¸ë²• êµì¬",
                        description: "ì‰½ê³  ì¬ë¯¸ìˆëŠ” ì˜ë¬¸ë²• í•™ìŠµ",
                        link: "#",
                        bgColor: "bg-orange-50",
                        textColor: "text-orange-800",
                        buttonColor: "bg-orange-600 hover:bg-orange-700"
                    },
                    {
                        id: 5,
                        title: "í•´ì™¸ ì–´í•™ì—°ìˆ˜",
                        description: "ì €ë ´í•œ ë¹„ìš©ìœ¼ë¡œ í˜„ì§€ ê²½í—˜",
                        link: "#",
                        bgColor: "bg-indigo-50",
                        textColor: "text-indigo-800",
                        buttonColor: "bg-indigo-600 hover:bg-indigo-700"
                    }
                ];
            }

            init() {
                console.log('ê´‘ê³  ë°°ë„ˆ ì´ˆê¸°í™” ì‹œì‘...');

                // DOM ìš”ì†Œ ì°¾ê¸°
                this.container = document.getElementById('adBannerContainer');
                this.track = document.getElementById('adBannerTrack');

                console.log('Container found:', !!this.container);
                console.log('Track found:', !!this.track);

                if (!this.container || !this.track) {
                    console.error('ê´‘ê³  ë°°ë„ˆ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    console.log('Container element:', this.container);
                    console.log('Track element:', this.track);
                    return false;
                }

                // ê¸°ë³¸ ê´‘ê³  ë¡œë“œ
                this.ads = [...this.defaultAds];
                console.log('ê¸°ë³¸ ê´‘ê³  ê°œìˆ˜:', this.ads.length);

                this.render();
                this.start();
                this.setupHoverControls();

                this.isInitialized = true;
                console.log('ê´‘ê³  ë°°ë„ˆ ì´ˆê¸°í™” ì™„ë£Œ!');

                // ë°°ë„ˆê°€ ë³´ì´ëŠ”ì§€ í™•ì¸
                this.debugVisibility();
                return true;
            }

            // ê°€ì‹œì„± ë””ë²„ê¹…
            debugVisibility() {
                console.log('=== ê´‘ê³  ë°°ë„ˆ ê°€ì‹œì„± ë””ë²„ê·¸ ===');
                console.log('Container styles:', window.getComputedStyle(this.container));
                console.log('Container display:', window.getComputedStyle(this.container).display);
                console.log('Container height:', window.getComputedStyle(this.container).height);
                console.log('Track styles:', window.getComputedStyle(this.track));
                console.log('Track children count:', this.track.children.length);
                
                // ê° ê´‘ê³  ìš”ì†Œ í™•ì¸
                Array.from(this.track.children).forEach((child, index) => {
                    console.log(`Ad ${index} display:`, window.getComputedStyle(child).display);
                    console.log(`Ad ${index} content:`, child.innerHTML);
                });
            }

            render() {
                if (!this.track) {
                    console.error('Track ìš”ì†Œê°€ ì—†ì–´ì„œ ë Œë”ë§í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }

                console.log('ê´‘ê³  ë Œë”ë§ ì‹œì‘... ê´‘ê³  ê°œìˆ˜:', this.ads.length);
                
                // íŠ¸ë™ ì´ˆê¸°í™”
                this.track.innerHTML = '';
                
                if (this.ads.length === 0) {
                    console.warn('ë Œë”ë§í•  ê´‘ê³ ê°€ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                this.ads.forEach((ad, index) => {
                    const adElement = this.createAdElement(ad, index);
                    this.track.appendChild(adElement);
                    console.log(`ê´‘ê³  ${index + 1} ë Œë”ë§ ì™„ë£Œ:`, ad.title);
                });

                this.updatePosition();
                console.log('ëª¨ë“  ê´‘ê³  ë Œë”ë§ ì™„ë£Œ');
            }

            createAdElement(ad, index) {
                const adDiv = document.createElement('div');
                adDiv.className = `ad-item px-2`;

                // ì•ˆì „í•œ HTML ìƒì„±
                const title = this.escapeHtml(ad.title);
                const description = this.escapeHtml(ad.description);
                const link = this.escapeHtml(ad.link);

                adDiv.innerHTML = `
                    <div class="${ad.bgColor} ${ad.textColor} rounded-lg p-3 border border-gray-200 cursor-pointer transition-transform hover:scale-[1.02] w-full"
                         onclick="window.open('${link}', '_blank')"
                         style="min-height: 60px; height: 100%;">
                        <div class="flex items-center justify-between h-full">
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-semibold truncate">${title}</div>
                                <div class="text-xs opacity-80 truncate">${description}</div>
                            </div>
                            <button class="${ad.buttonColor} text-white text-xs px-3 py-1 rounded-full transition-colors ml-3 flex-shrink-0"
                                    onclick="event.stopPropagation(); window.open('${link}', '_blank')">
                                ë³´ê¸°
                            </button>
                        </div>
                    </div>
                `;
                
                console.log(`ê´‘ê³  ìš”ì†Œ ìƒì„± ì™„ë£Œ: ${title}`);
                return adDiv;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            updatePosition() {
                if (!this.track || this.ads.length === 0) return;
                
                const translateX = -this.currentIndex * 100;
                this.track.style.transform = `translateX(${translateX}%)`;
                console.log(`ìœ„ì¹˜ ì—…ë°ì´íŠ¸: ${this.currentIndex}ë²ˆì§¸ ê´‘ê³ ë¡œ ì´ë™`);
            }

            next() {
                if (this.ads.length <= 1) return;
                
                this.currentIndex = (this.currentIndex + 1) % this.ads.length;
                this.updatePosition();
                console.log(`ë‹¤ìŒ ê´‘ê³ : ${this.currentIndex + 1}/${this.ads.length}`);
            }

            prev() {
                if (this.ads.length <= 1) return;
                
                this.currentIndex = this.currentIndex === 0 ? this.ads.length - 1 : this.currentIndex - 1;
                this.updatePosition();
                console.log(`ì´ì „ ê´‘ê³ : ${this.currentIndex + 1}/${this.ads.length}`);
            }

            start() {
                if (this.isPlaying || this.ads.length <= 1) return;
                
                this.isPlaying = true;
                this.intervalId = setInterval(() => {
                    this.next();
                }, this.displayDuration);
                
                console.log('ìë™ ë¡¤ë§ ì‹œì‘');
            }

            stop() {
                if (!this.isPlaying) return;
                
                this.isPlaying = false;
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                    this.intervalId = null;
                }
                
                console.log('ìë™ ë¡¤ë§ ì •ì§€');
            }

            setupHoverControls() {
                if (!this.container) return;

                this.container.addEventListener('mouseenter', () => {
                    console.log('ë§ˆìš°ìŠ¤ í˜¸ë²„: ë¡¤ë§ ì •ì§€');
                    this.stop();
                });

                this.container.addEventListener('mouseleave', () => {
                    console.log('ë§ˆìš°ìŠ¤ ì•„ì›ƒ: ë¡¤ë§ ì¬ì‹œì‘');
                    this.start();
                });
            }

            addAd(ad) {
                if (!ad || !ad.title || !ad.description) {
                    console.error('ìœ íš¨í•˜ì§€ ì•Šì€ ê´‘ê³  ë°ì´í„°:', ad);
                    return false;
                }

                const newAd = {
                    id: Date.now(),
                    title: ad.title,
                    description: ad.description,
                    link: ad.link || '#',
                    bgColor: ad.bgColor || 'bg-gray-50',
                    textColor: ad.textColor || 'text-gray-800',
                    buttonColor: ad.buttonColor || 'bg-gray-600 hover:bg-gray-700'
                };

                this.ads.push(newAd);
                console.log('ìƒˆ ê´‘ê³  ì¶”ê°€:', newAd.title);
                
                if (this.isInitialized) {
                    this.render();
                    
                    if (this.ads.length > 1 && !this.isPlaying) {
                        this.start();
                    }
                }

                return true;
            }

            removeAd(adId) {
                const initialLength = this.ads.length;
                this.ads = this.ads.filter(ad => ad.id !== adId);
                
                if (this.ads.length !== initialLength) {
                    console.log('ê´‘ê³  ì œê±°ë¨. ë‚¨ì€ ê´‘ê³  ìˆ˜:', this.ads.length);
                    
                    if (this.currentIndex >= this.ads.length) {
                        this.currentIndex = 0;
                    }
                    
                    if (this.isInitialized) {
                        this.render();
                        
                        if (this.ads.length <= 1) {
                            this.stop();
                        }
                    }
                    
                    return true;
                }
                
                return false;
            }

            getAds() {
                return [...this.ads];
            }

            getAdCount() {
                return this.ads.length;
            }

            getCurrentIndex() {
                return this.currentIndex;
            }

            getStatus() {
                return {
                    isInitialized: this.isInitialized,
                    isPlaying: this.isPlaying,
                    currentIndex: this.currentIndex,
                    totalAds: this.ads.length,
                    displayDuration: this.displayDuration,
                    animationDuration: this.animationDuration,
                    containerFound: !!this.container,
                    trackFound: !!this.track
                };
            }
        }

        // ì „ì—­ ê´‘ê³  ë°°ë„ˆ ê´€ë¦¬ì ì¸ìŠ¤í„´ìŠ¤
        let adBannerManager = null;

        // ê´‘ê³  ë°°ë„ˆ ê´€ë¦¬ í•¨ìˆ˜ë“¤ (ì™¸ë¶€ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
        function addAdvertisement(ad) {
            if (adBannerManager) {
                return adBannerManager.addAd(ad);
            }
            return false;
        }

        function removeAdvertisement(adId) {
            if (adBannerManager) {
                return adBannerManager.removeAd(adId);
            }
            return false;
        }

        function getAdvertisements() {
            if (adBannerManager) {
                return adBannerManager.getAds();
            }
            return [];
        }

        function getBannerStatus() {
            if (adBannerManager) {
                return adBannerManager.getStatus();
            }
            return null;
        }

        // ê´‘ê³  ë°°ë„ˆ ì˜ˆì œ ì¶”ê°€ í•¨ìˆ˜ (í…ŒìŠ¤íŠ¸ìš©)
        function addSampleAd() {
            const sampleAds = [
                {
                    title: "ìŠ¤í”¼í‚¹ í´ëŸ½",
                    description: "ì‹¤ì „ ì˜ì–´ íšŒí™” ì—°ìŠµ",
                    link: "https://example.com/speaking",
                    bgColor: "bg-red-50",
                    textColor: "text-red-800",
                    buttonColor: "bg-red-600 hover:bg-red-700"
                },
                {
                    title: "ì˜ì–´ ë„ì„œê´€",
                    description: "ë¬´ë£Œ ì˜ì–´ ì›ì„œ ì½ê¸°",
                    link: "https://example.com/library",
                    bgColor: "bg-teal-50",
                    textColor: "text-teal-800",
                    buttonColor: "bg-teal-600 hover:bg-teal-700"
                },
                {
                    title: "ë°œìŒ êµì •",
                    description: "AI ë°œìŒ ë¶„ì„ ì„œë¹„ìŠ¤",
                    link: "https://example.com/pronunciation",
                    bgColor: "bg-pink-50",
                    textColor: "text-pink-800",
                    buttonColor: "bg-pink-600 hover:bg-pink-700"
                }
            ];
            
            const randomAd = sampleAds[Math.floor(Math.random() * sampleAds.length)];
            return addAdvertisement(randomAd);
        }

        // í…ìŠ¤íŠ¸ì—ì„œ ë°ì´í„° ì¶”ì¶œ
        function extractDataFromText(text, idiom) {
            // ê°„ë‹¨í•œ íŒ¨í„´ ë§¤ì¹­ìœ¼ë¡œ ì •ë³´ ì¶”ì¶œ ì‹œë„
            const meaningMatch = text.match(/"meaning":\s*"([^"]+)"/);
            const exampleMatch = text.match(/"example":\s*"([^"]+)"/);
            
            return {
                meaning: meaningMatch ? meaningMatch[1] : `${idiom}ì˜ ì˜ë¯¸`,
                example: exampleMatch ? exampleMatch[1] : `"${idiom}" ì˜ˆë¬¸ì…ë‹ˆë‹¤.`,
                quiz: generateSimpleQuiz(idiom, meaningMatch ? meaningMatch[1] : `${idiom}ì˜ ì˜ë¯¸`)
            };
        }

        // ë°±ì—… í€´ì¦ˆ ìƒì„±
        function generateFallbackQuiz(idiom, meaning, example) {
            return {
                meaning: meaning || `${idiom}ì˜ ì˜ë¯¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`,
                example: example || `"${idiom}" ì‚¬ìš© ì˜ˆì‹œì…ë‹ˆë‹¤.`,
                quiz: generateSimpleQuiz(idiom, meaning || `${idiom}ì˜ ì˜ë¯¸`)
            };
        }

        // ê°„ë‹¨í•œ í€´ì¦ˆ ìƒì„±
        function generateSimpleQuiz(idiom, meaning) {
            const commonWrongAnswers = [
                "ì§ì—­ì ì¸ ì˜ë¯¸",
                "ë°˜ëŒ€ë˜ëŠ” ê°œë…",
                "ë¹„ìŠ·í•˜ì§€ë§Œ ë‹¤ë¥¸ ëœ»",
                "ê´€ë ¨ ì—†ëŠ” ì˜ë¯¸"
            ];
            
            const options = [meaning, ...commonWrongAnswers.slice(0, 3)];
            const shuffled = options.sort(() => Math.random() - 0.5);
            const correctIndex = shuffled.indexOf(meaning);

            return {
                question: `ë‹¤ìŒ ì¤‘ '${idiom}'ì˜ ì˜ë¯¸ëŠ”?`,
                options: shuffled,
                correct: correctIndex
            };
        }

        // ë°±ì—… ìˆ™ì–´ ë°ì´í„°
        function getFallbackIdiomData(idiom) {
            const fallbackData = {
                "break the ice": {
                    meaning: "ì–´ìƒ‰í•œ ë¶„ìœ„ê¸°ë¥¼ ê¹¨ë‹¤",
                    example: "Let me tell a joke to break the ice."
                },
                "piece of cake": {
                    meaning: "ì•„ì£¼ ì‰¬ìš´ ì¼",
                    example: "The test was a piece of cake."
                },
                "hit the books": {
                    meaning: "ì—´ì‹¬íˆ ê³µë¶€í•˜ë‹¤",
                    example: "I need to hit the books for tomorrow's exam."
                },
                "under the weather": {
                    meaning: "ëª¸ì´ ì•ˆ ì¢‹ë‹¤",
                    example: "I'm feeling under the weather today."
                },
                "burn the midnight oil": {
                    meaning: "ë°¤ëŠ¦ê²Œê¹Œì§€ ì¼í•˜ë‹¤",
                    example: "She's been burning the midnight oil to finish the project."
                },
                "beat around the bush": {
                    meaning: "ëŒë ¤ì„œ ë§í•˜ë‹¤",
                    example: "Stop beating around the bush and tell me what happened."
                }
            };

            const data = fallbackData[idiom] || {
                meaning: "ìˆ™ì–´ì˜ ì˜ë¯¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
                example: `"${idiom}" ì‚¬ìš© ì˜ˆì‹œì…ë‹ˆë‹¤.`
            };

            return {
                idiom: idiom,
                meaning: data.meaning,
                example: data.example,
                quiz: generateQuiz(idiom, data.meaning)
            };
        }

        // í€´ì¦ˆ ìë™ ìƒì„±
        function generateQuiz(idiom, meaning) {
            const wrongOptions = [
                "ì§ì—­ì  ì˜ë¯¸",
                "ë°˜ëŒ€ì˜ ì˜ë¯¸",
                "ë¹„ìŠ·í•˜ì§€ë§Œ ë‹¤ë¥¸ ì˜ë¯¸"
            ];

            const options = [meaning, ...wrongOptions];
            const shuffled = options.sort(() => Math.random() - 0.5);
            const correctIndex = shuffled.indexOf(meaning);

            return {
                question: `ë‹¤ìŒ ì¤‘ '${idiom}'ì˜ ì˜ë¯¸ëŠ”?`,
                options: shuffled,
                correct: correctIndex
            };
        }

        // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
        function showError(message) {
            const errorDiv = getElement('errorMessage');
            const errorText = getElement('errorText');
            if (errorText) {
                errorText.textContent = message;
            }
            showElement(errorDiv);
            
            setTimeout(() => {
                hideElement(errorDiv);
            }, 5000);
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const streakElement = getElement('streakCount');
            const totalElement = getElement('totalLearned');
            const scoreElement = getElement('quizScore');

            if (streakElement) streakElement.textContent = appState.stats.streak;
            if (totalElement) totalElement.textContent = appState.stats.total;
            
            if (scoreElement) {
                const accuracy = appState.stats.attempts > 0 ? Math.round((appState.stats.correct / appState.stats.attempts) * 100) : 0;
                scoreElement.textContent = accuracy + '%';
            }
        }

        // ì•ŒëŒ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function setAlarm() {
            const timeInput = getElement('alarmTime');
            const alarmTime = timeInput ? timeInput.value : '';
            
            if (!alarmTime) {
                alert('ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            scheduleAlarmWithoutNotification(alarmTime);
        }

        function scheduleAlarmWithoutNotification(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            const now = new Date();
            const alarmDate = new Date();
            alarmDate.setHours(hours, minutes, 0, 0);

            if (alarmDate <= now) {
                alarmDate.setDate(alarmDate.getDate() + 1);
            }

            const timeUntilAlarm = alarmDate.getTime() - now.getTime();

            if (appState.alarmTimeout) {
                clearTimeout(appState.alarmTimeout);
            }

            appState.alarmTimeout = setTimeout(() => {
                showAlarmModal();
            }, timeUntilAlarm);

            localStorage.setItem('alarmTime', timeString);
            localStorage.setItem('alarmSet', 'true');
            
            updateAlarmStatus(true, timeString);
        }

        function cancelAlarm() {
            if (appState.alarmTimeout) {
                clearTimeout(appState.alarmTimeout);
                appState.alarmTimeout = null;
            }
            localStorage.removeItem('alarmTime');
            localStorage.removeItem('alarmSet');
            updateAlarmStatus(false);
        }

        function updateAlarmStatus(isActive, timeString = '') {
            const statusDiv = getElement('alarmStatus');
            if (statusDiv) {
                if (isActive) {
                    statusDiv.className = 'mt-4 text-center py-2 px-4 rounded-lg bg-green-100 text-green-700';
                    statusDiv.textContent = `ì•ŒëŒì´ ${timeString}ì— ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤`;
                } else {
                    statusDiv.className = 'mt-4 text-center py-2 px-4 rounded-lg bg-gray-100 text-gray-600';
                    statusDiv.textContent = 'ì•ŒëŒì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤';
                }
            }
        }

        function showAlarmModal() {
            const modal = getElement('alarmModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function startAlarmLesson() {
            hideElement('alarmModal');
            const levels = ['beginner', 'intermediate', 'advanced'];
            const randomLevel = levels[Math.floor(Math.random() * levels.length)];
            selectLevel(randomLevel);
        }

        function snoozeAlarm() {
            hideElement('alarmModal');
            appState.alarmTimeout = setTimeout(() => {
                showAlarmModal();
            }, 5 * 60 * 1000);
        }

        function dismissAlarm() {
            hideElement('alarmModal');
        }

        // ìŒì„± ê´€ë ¨ í•¨ìˆ˜ë“¤
        let preferredVoices = {};
        
        function loadVoices() {
            if (speechSupported) {
                const voices = speechSynthesis.getVoices();
                preferredVoices.main = voices.find(v => v.lang.startsWith('en')) || voices[0];
            }
        }

        function createOptimizedUtterance(text, options = {}) {
            const utterance = new SpeechSynthesisUtterance(text);
            if (preferredVoices.main) {
                utterance.voice = preferredVoices.main;
            }
            utterance.lang = options.lang || 'en-US';
            utterance.rate = options.rate || 0.85;
            utterance.pitch = options.pitch || 1.0;
            utterance.volume = options.volume || 0.9;
            return utterance;
        }

        function speakIdiom() {
            if (!speechSupported || !appState.currentIdiom) return;
            const utterance = createOptimizedUtterance(appState.currentIdiom.idiom, { rate: 0.8 });
            speechSynthesis.speak(utterance);
        }

        function speakExample() {
            if (!speechSupported || !appState.currentIdiom) return;
            const utterance = createOptimizedUtterance(appState.currentIdiom.example, { rate: 0.9 });
            speechSynthesis.speak(utterance);
        }

        function startListening() {
            if (!recognitionSupported || !appState.currentIdiom || !appState.recognition) return;

            const listenBtn = getElement('listenBtn');
            const resultDiv = getElement('recognitionResult');
            const feedbackDiv = getElement('voiceFeedback');

            if (feedbackDiv) {
                feedbackDiv.innerHTML = '';
                feedbackDiv.className = 'p-2 sm:p-3 rounded text-sm sm:text-base';
            }

            if (listenBtn) {
                listenBtn.style.backgroundColor = '#10b981';
            }

            if (resultDiv) {
                resultDiv.textContent = 'ë“£ê³  ìˆìŠµë‹ˆë‹¤... ì²œì²œíˆ ë˜ë°•ë˜ë°• ë§í•´ì£¼ì„¸ìš”';
            }

            appState.recognition.start();

            appState.recognition.onresult = function(event) {
                const result = event.results[0][0].transcript.toLowerCase().trim();
                const target = appState.currentIdiom.idiom.toLowerCase();
                
                if (resultDiv) {
                    resultDiv.innerHTML = `ë‹¹ì‹ ì˜ ë°œìŒ: "<strong>${result}</strong>"`;
                }
                
                const similarity = calculateSimilarity(result, target);
                
                setTimeout(() => {
                    showDetailedFeedback(similarity, result, target);
                }, 500);
            };

            appState.recognition.onerror = function(event) {
                if (resultDiv) {
                    resultDiv.textContent = 'ìŒì„± ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                }
                if (feedbackDiv) {
                    feedbackDiv.innerHTML = '<button class="px-3 py-1 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm" onclick="startListening()">ë‹¤ì‹œ ì‹œë„</button>';
                }
            };

            appState.recognition.onend = function() {
                if (listenBtn) {
                    listenBtn.style.backgroundColor = '';
                }
            };
        }

        function playTargetAudio() {
            if (!appState.currentIdiom) return;
            const utterance = createOptimizedUtterance(appState.currentIdiom.idiom, { rate: 0.7 });
            speechSynthesis.speak(utterance);
        }

        function showDetailedFeedback(similarity, userSpeech, target) {
            const feedbackDiv = getElement('voiceFeedback');
            if (!feedbackDiv) return;

            let feedbackClass = '';
            let feedbackText = '';

            if (similarity > 0.8) {
                feedbackClass = 'bg-green-100 text-green-700 border border-green-300';
                feedbackText = 'ì™„ë²½í•œ ë°œìŒì…ë‹ˆë‹¤!';
            } else if (similarity > 0.6) {
                feedbackClass = 'bg-yellow-100 text-yellow-700 border border-yellow-300';
                feedbackText = 'ì¢‹ì€ ë°œìŒì…ë‹ˆë‹¤!';
            } else {
                feedbackClass = 'bg-red-100 text-red-700 border border-red-300';
                feedbackText = 'ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!';
            }

            feedbackDiv.className = `p-2 sm:p-3 rounded ${feedbackClass} text-sm sm:text-base`;
            feedbackDiv.innerHTML = `
                <div class="mb-2">${feedbackText}</div>
                <div class="text-xs sm:text-sm mb-3">ì •í™•ë„: ${Math.round(similarity * 100)}%</div>
                <div class="flex gap-2 justify-center">
                    <button class="px-3 py-1 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-xs sm:text-sm" onclick="startListening()">ë‹¤ì‹œ ì—°ìŠµ</button>
                    <button class="px-3 py-1 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-xs sm:text-sm" onclick="playTargetAudio()">ëª©í‘œ ë°œìŒ</button>
                </div>
            `;
        }

        function calculateSimilarity(str1, str2) {
            const words1 = str1.split(' ');
            const words2 = str2.split(' ');
            let matches = 0;

            words1.forEach(word1 => {
                if (words2.some(word2 => word2.includes(word1) || word1.includes(word2))) {
                    matches++;
                }
            });

            return matches / Math.max(words1.length, words2.length);
        }

        // ë ˆë²¨ ì„ íƒ
        async function selectLevel(level) {
            appState.currentLevel = level;
            appState.currentStep = 0;
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            const levelBtns = querySelectorAll('.level-btn');
            levelBtns.forEach(btn => {
                if (btn.dataset.level === level) {
                    btn.className = 'level-btn py-3 px-4 bg-gray-700 text-white rounded-lg font-medium text-sm sm:text-base';
                } else {
                    btn.className = 'level-btn py-3 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium text-sm sm:text-base';
                }
            });
            
            // í•™ìŠµ ì„¹ì…˜ í‘œì‹œ
            showElement('learningSection');
            
            // ëœë¤ ìˆ™ì–´ ë¡œë“œ
            await loadRandomIdiom(level);
        }

        // ëœë¤ ìˆ™ì–´ ë¡œë“œ
        async function loadRandomIdiom(level) {
            const idioms = idiomDatabase[level];
            const randomIdiom = idioms[Math.floor(Math.random() * idioms.length)];
            
            try {
                appState.currentIdiom = await fetchIdiomData(randomIdiom);
                displayIdiom();
                updateProgress(25);
            } catch (error) {
                showError('ìˆ™ì–´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error('ìˆ™ì–´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ìˆ™ì–´ ì •ë³´ í‘œì‹œ
        function displayIdiom() {
            if (!appState.currentIdiom) return;

            const titleElement = getElement('idiomTitle');
            const meaningElement = getElement('idiomMeaning');
            const exampleElement = getElement('idiomExample');

            if (titleElement) {
                titleElement.innerHTML = `
                    ${appState.currentIdiom.idiom}
                    <button onclick="speakIdiom()" class="w-8 h-8 sm:w-10 sm:h-10 bg-gray-600 text-white rounded-full hover:bg-gray-700 transition-colors text-sm sm:text-base">ğŸ”Š</button>
                `;
            }

            if (meaningElement) {
                meaningElement.textContent = appState.currentIdiom.meaning;
            }

            if (exampleElement) {
                exampleElement.innerHTML = `
                    "${appState.currentIdiom.example}"
                    <button onclick="speakExample()" class="w-8 h-8 sm:w-10 sm:h-10 bg-gray-600 text-white rounded-full hover:bg-gray-700 transition-colors text-sm sm:text-base">ğŸ”Š</button>
                `;
            }
            
            hideElement('voiceControls');
        }

        // ìƒˆ ìˆ™ì–´ë¡œ ë‹¤ì‹œ ì‹œë„
        async function retryWithNewIdiom() {
            if (!appState.currentLevel) return;
            
            resetLearningState();
            await loadRandomIdiom(appState.currentLevel);
        }

        // í•™ìŠµ ìƒíƒœ ì´ˆê¸°í™”
        function resetLearningState() {
            appState.currentStep = 0;
            hideElement('voiceControls');
            hideElement('quizSection');
            showElement('quizLearningContent');
            hideElement('actualQuiz');
            
            const idiomCard = querySelector('.idiom-card');
            if (idiomCard) {
                idiomCard.style.display = 'block';
            }
            
            const resultElement = getElement('recognitionResult');
            const feedbackElement = getElement('voiceFeedback');
            
            if (resultElement) {
                resultElement.textContent = 'ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°œìŒì„ ì‹œì‘í•˜ì„¸ìš”';
            }
            
            if (feedbackElement) {
                feedbackElement.innerHTML = '';
                feedbackElement.className = 'p-2 sm:p-3 rounded text-sm sm:text-base';
            }
            
            showElement('startBtn');
            hideElement('nextBtn');
            hideElement('teacherBtn');
            hideElement('retryBtn');
        }

        // í•™ìŠµ ì‹œì‘
        function startLearning() {
            appState.currentStep = 1;
            updateProgress(50);
            
            if (speechSupported || recognitionSupported) {
                showElement('voiceControls');
                const voiceTarget = getElement('voiceTarget');
                if (voiceTarget && appState.currentIdiom) {
                    voiceTarget.textContent = `ëª©í‘œ ë°œìŒ: "${appState.currentIdiom.idiom}"`;
                }
            }
            
            hideElement('startBtn');
            showElement('nextBtn');
        }

        function nextStep() {
            if (appState.currentStep === 1) {
                showQuiz();
            }
        }

        function showQuiz() {
            appState.currentStep = 2;
            updateProgress(75);
            
            const quizTitleElement = getElement('quizIdiomTitle');
            const quizMeaningElement = getElement('quizIdiomMeaning');
            const quizExampleElement = getElement('quizIdiomExample');

            if (appState.currentIdiom) {
                if (quizTitleElement) quizTitleElement.textContent = appState.currentIdiom.idiom;
                if (quizMeaningElement) quizMeaningElement.textContent = appState.currentIdiom.meaning;
                if (quizExampleElement) quizExampleElement.textContent = `"${appState.currentIdiom.example}"`;
            }
            
            showElement('quizSection');
            hideElement('nextBtn');
        }

        function showActualQuiz() {
            const quiz = appState.currentIdiom.quiz;
            
            hideElement('quizLearningContent');
            const idiomCard = querySelector('.idiom-card');
            if (idiomCard) {
                idiomCard.style.display = 'none';
            }
            hideElement('voiceControls');
            
            const questionElement = getElement('quizQuestion');
            if (questionElement) {
                questionElement.textContent = quiz.question;
            }
            
            const optionsDiv = getElement('quizOptions');
            if (optionsDiv) {
                optionsDiv.innerHTML = '';
                
                quiz.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'p-3 sm:p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors text-sm sm:text-base';
                    optionDiv.textContent = option;
                    optionDiv.addEventListener('click', () => selectAnswer(index));
                    optionsDiv.appendChild(optionDiv);
                });
            }
            
            showElement('actualQuiz');
        }

        // ë‹µì•ˆ ì„ íƒ
        function selectAnswer(selectedIndex) {
            const quiz = appState.currentIdiom.quiz;
            const options = querySelectorAll('#quizOptions > div');
            
            appState.stats.attempts++;
            
            if (selectedIndex === quiz.correct) {
                if (options[selectedIndex]) {
                    options[selectedIndex].className = 'p-3 sm:p-4 border-2 border-green-500 bg-green-100 rounded-lg text-green-700 text-sm sm:text-base';
                }
                appState.stats.correct++;
                appState.stats.total++;
                appState.stats.streak++;
            } else {
                if (options[selectedIndex]) {
                    options[selectedIndex].className = 'p-3 sm:p-4 border-2 border-red-500 bg-red-100 rounded-lg text-red-700 text-sm sm:text-base';
                }
                if (options[quiz.correct]) {
                    options[quiz.correct].className = 'p-3 sm:p-4 border-2 border-green-500 bg-green-100 rounded-lg text-green-700 text-sm sm:text-base';
                }
                appState.stats.streak = 0;
            }
            
            options.forEach(option => {
                option.onclick = null;
                option.style.cursor = 'default';
            });
            
            localStorage.setItem('idiomStats', JSON.stringify(appState.stats));
            updateStats();
            
            setTimeout(() => {
                const idiomCard = querySelector('.idiom-card');
                if (idiomCard) {
                    idiomCard.style.display = 'block';
                }
                showElement('teacherBtn');
                showElement('retryBtn');
            }, 1500);
        }

        // ê°•ì‚¬ ë³µìŠµ
        function showTeacher() {
            appState.currentStep = 3;
            updateProgress(100);
            
            const teacherAvatar = getElement('teacherAvatar');
            const teacherMessage = getElement('teacherMessage');
            
            const teachers = {
                beginner: {
                    avatar: 'ğŸ‘©â€ğŸ«',
                    message: `ì˜¤ëŠ˜ "${appState.currentIdiom.idiom}"ë¥¼ ë°°ì› ë„¤ìš”! ì´ í‘œí˜„ì€ ì¼ìƒ ëŒ€í™”ì—ì„œ ìì£¼ ì‚¬ìš©ë˜ëŠ” ìœ ìš©í•œ ìˆ™ì–´ì…ë‹ˆë‹¤. ì¹œêµ¬ë“¤ê³¼ ëŒ€í™”í•  ë•Œ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•´ë³´ì„¸ìš”. ë‚´ì¼ë„ ìƒˆë¡œìš´ ìˆ™ì–´ë¡œ ë§Œë‚˜ìš”!`
                },
                intermediate: {
                    avatar: 'ğŸ‘¨â€ğŸ«',
                    message: `"${appState.currentIdiom.idiom}"ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ìƒí™©ì—ì„œë„ ìì£¼ ì“°ì´ëŠ” í‘œí˜„ì…ë‹ˆë‹¤. ë¹„ìŠ·í•œ ì˜ë¯¸ì˜ ë‹¤ë¥¸ í‘œí˜„ë“¤ë„ í•¨ê»˜ ê¸°ì–µí•´ë‘ì‹œë©´ ë”ìš± í’ë¶€í•œ ì˜ì–´ í‘œí˜„ì´ ê°€ëŠ¥í•  ê±°ì˜ˆìš”.`
                },
                advanced: {
                    avatar: 'ğŸ‘©â€ğŸ’¼',
                    message: `"${appState.currentIdiom.idiom}"ëŠ” ì˜ì–´ê¶Œ ë¬¸í™”ì˜ ê¹Šì€ ì´í•´ê°€ í•„ìš”í•œ ê³ ê¸‰ í‘œí˜„ì…ë‹ˆë‹¤. ì´ëŸ° ìˆ™ì–´ë“¤ì„ ììœ ìì¬ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ë©´ ì›ì–´ë¯¼ê³¼ì˜ ëŒ€í™”ì—ì„œë„ ìì‹ ê°ì„ ê°€ì§ˆ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.`
                }
            };
            
            const teacher = teachers[appState.currentLevel];
            if (teacherAvatar) teacherAvatar.textContent = teacher.avatar;
            if (teacherMessage) teacherMessage.textContent = teacher.message;
            
            showElement('teacherSection');
            hideElement('learningSection');
        }

        // í•™ìŠµ ì™„ë£Œ
        function finishLesson() {
            hideElement('teacherSection');
            resetLearningState();
            hideElement('learningSection');
            
            const levelBtns = querySelectorAll('.level-btn');
            levelBtns.forEach(btn => {
                btn.className = 'level-btn py-3 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium text-sm sm:text-base';
            });
            
            appState.currentLevel = null;
            appState.currentIdiom = null;
            updateProgress(0);
            
            alert('ğŸ‰ ì˜¤ëŠ˜ì˜ í•™ìŠµì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ë‚´ì¼ë„ í•¨ê»˜ í•´ìš”!');
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(percent) {
            const progressFill = getElement('progressFill');
            if (progressFill) {
                progressFill.style.width = percent + '%';
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        function setupEventListeners() {
            // ì•ŒëŒ ë²„íŠ¼ë“¤
            const setAlarmBtn = getElement('setAlarmBtn');
            const cancelAlarmBtn = getElement('cancelAlarmBtn');
            
            if (setAlarmBtn) {
                setAlarmBtn.addEventListener('click', setAlarm);
            }
            
            if (cancelAlarmBtn) {
                cancelAlarmBtn.addEventListener('click', cancelAlarm);
            }

            // ë ˆë²¨ ì„ íƒ ë²„íŠ¼ë“¤
            const levelBtns = querySelectorAll('.level-btn');
            levelBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const level = btn.dataset.level;
                    if (level) {
                        selectLevel(level);
                    }
                });
            });

            // í•™ìŠµ ë²„íŠ¼ë“¤
            const startBtn = getElement('startBtn');
            const nextBtn = getElement('nextBtn');
            const teacherBtn = getElement('teacherBtn');
            const retryBtn = getElement('retryBtn');
            const finishBtn = getElement('finishBtn');
            const showQuizBtn = getElement('showQuizBtn');

            if (startBtn) startBtn.addEventListener('click', startLearning);
            if (nextBtn) nextBtn.addEventListener('click', nextStep);
            if (teacherBtn) teacherBtn.addEventListener('click', showTeacher);
            if (retryBtn) retryBtn.addEventListener('click', retryWithNewIdiom);
            if (finishBtn) finishBtn.addEventListener('click', finishLesson);
            if (showQuizBtn) showQuizBtn.addEventListener('click', showActualQuiz);

            // ìŒì„± ê´€ë ¨ ë²„íŠ¼ë“¤
            const listenBtn = getElement('listenBtn');
            const playTargetBtn = getElement('playTargetBtn');

            if (listenBtn) listenBtn.addEventListener('click', startListening);
            if (playTargetBtn) playTargetBtn.addEventListener('click', playTargetAudio);

            // ì•ŒëŒ ëª¨ë‹¬ ë²„íŠ¼ë“¤
            const startAlarmLessonBtn = getElement('startAlarmLessonBtn');
            const snoozeAlarmBtn = getElement('snoozeAlarmBtn');
            const dismissAlarmBtn = getElement('dismissAlarmBtn');

            if (startAlarmLessonBtn) startAlarmLessonBtn.addEventListener('click', startAlarmLesson);
            if (snoozeAlarmBtn) snoozeAlarmBtn.addEventListener('click', snoozeAlarm);
            // API í‚¤ ëª¨ë‹¬ ë²„íŠ¼ë“¤ (ê°œì„ ëœ ë²„ì „)
            const saveApiKeyBtn = getElement('saveApiKeyBtn');
            const deleteApiKeyBtn = getElement('deleteApiKeyBtn');
            const testApiKeyBtn = getElement('testApiKeyBtn');
            const skipApiKeyBtn = getElement('skipApiKeyBtn');
            const closeApiKeyModalBtn = getElement('closeApiKeyModalBtn');
            const toggleVisibilityBtn = getElement('toggleApiKeyVisibility');

            if (saveApiKeyBtn) saveApiKeyBtn.addEventListener('click', saveApiKey);
            if (deleteApiKeyBtn) deleteApiKeyBtn.addEventListener('click', deleteApiKey);
            if (testApiKeyBtn) testApiKeyBtn.addEventListener('click', testApiKey);
            if (skipApiKeyBtn) skipApiKeyBtn.addEventListener('click', skipApiKey);
            if (closeApiKeyModalBtn) closeApiKeyModalBtn.addEventListener('click', hideApiKeyModal);
            if (toggleVisibilityBtn) toggleVisibilityBtn.addEventListener('click', toggleApiKeyVisibility);

            // API í‚¤ ì…ë ¥ì—ì„œ Enter í‚¤ ì²˜ë¦¬
            const apiKeyInput = getElement('apiKeyInput');
            if (apiKeyInput) {
                apiKeyInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveApiKey();
                    }
                });
                
                // ì‹¤ì‹œê°„ ìœ íš¨ì„± ê²€ì‚¬
                apiKeyInput.addEventListener('input', (e) => {
                    const value = e.target.value.trim();
                    const saveBtn = getElement('saveApiKeyBtn');
                    const testBtn = getElement('testApiKeyBtn');
                    
                    if (saveBtn && testBtn) {
                        const isValid = value.length > 0 && value.startsWith('AIzaSy');
                        saveBtn.disabled = !value;
                        testBtn.disabled = !value;
                        
                        if (!isValid && value.length > 0) {
                            saveBtn.className = 'flex-1 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors';
                            saveBtn.textContent = 'í˜•ì‹ í™•ì¸';
                        } else {
                            saveBtn.className = 'flex-1 px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors';
                            saveBtn.textContent = 'ì €ì¥';
                        }
                    }
                });
            }
        }

        // ë·°í¬íŠ¸ ë†’ì´ ì¡°ì •
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // ì´ˆê¸°í™” í•¨ìˆ˜ (ë¹„ë™ê¸° ì²˜ë¦¬ ê°œì„ )
        async function initializeApp() {
            console.log('ì•± ì´ˆê¸°í™” ì‹œì‘...');
            
            try {
                // í†µê³„ ì—…ë°ì´íŠ¸
                updateStats();
                
                // ìŒì„± ì¸ì‹ ì´ˆê¸°í™”
                initSpeechRecognition();
                
                // ìŒì„± í•©ì„± ì´ˆê¸°í™”
                if (speechSupported) {
                    loadVoices();
                    speechSynthesis.onvoiceschanged = loadVoices;
                }
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                setupEventListeners();
                
                // ì €ì¥ëœ ì•ŒëŒ ë³µì›
                const savedAlarmTime = localStorage.getItem('alarmTime');
                const alarmWasSet = localStorage.getItem('alarmSet');
                
                if (savedAlarmTime && alarmWasSet) {
                    const alarmTimeInput = getElement('alarmTime');
                    if (alarmTimeInput) {
                        alarmTimeInput.value = savedAlarmTime;
                    }
                    scheduleAlarmWithoutNotification(savedAlarmTime);
                }

                // ë·°í¬íŠ¸ ë†’ì´ ì„¤ì •
                setViewportHeight();
                window.addEventListener('resize', setViewportHeight);
                window.addEventListener('orientationchange', setViewportHeight);
                
                // API í‚¤ í™•ì¸ (ë¹„ë™ê¸°)
                await new Promise(resolve => {
                    setTimeout(() => {
                        checkApiKeyOnStartup();
                        resolve();
                    }, 100);
                });
                
                // ê´‘ê³  ë°°ë„ˆ ì´ˆê¸°í™” (ë¹„ë™ê¸°)
                await new Promise(resolve => {
                    const initBanner = () => {
                        const container = document.getElementById('adBannerContainer');
                        const track = document.getElementById('adBannerTrack');

                        if (container && track) {
                            try {
                                adBannerManager = new AdBannerManager();
                                adBannerManager.init();
                                resolve();
                            } catch (error) {
                                console.error('ê´‘ê³  ë°°ë„ˆ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                                resolve(); // ì˜¤ë¥˜ê°€ ìˆì–´ë„ ê³„ì† ì§„í–‰
                            }
                        } else {
                            // DOM ìš”ì†Œê°€ ì•„ì§ ì—†ìœ¼ë©´ ë‹¤ì‹œ ì‹œë„
                            setTimeout(initBanner, 100);
                        }
                    };

                    setTimeout(initBanner, 200);
                });
                
                console.log('ì•± ì´ˆê¸°í™” ì™„ë£Œ!');
                
            } catch (error) {
                console.error('ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                // ì˜¤ë¥˜ê°€ ìˆì–´ë„ ê¸°ë³¸ ê¸°ëŠ¥ì€ ì‘ë™í•˜ë„ë¡ í•¨
                showError('ì¼ë¶€ ê¸°ëŠ¥ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ê¸°ëŠ¥ì€ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.');
            }
        }

        // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™” (ì•ˆì „í•œ ì—ëŸ¬ ì²˜ë¦¬ í¬í•¨)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ (Promise rejection ì²˜ë¦¬)
        window.addEventListener('unhandledrejection', function(event) {
            console.warn('Unhandled promise rejection:', event.reason);
            // ë©”ì‹œì§€ ì±„ë„ ê´€ë ¨ ì˜¤ë¥˜ëŠ” ë¬´ì‹œ (ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ ë¬¸ì œ)
            if (event.reason && event.reason.message && 
                event.reason.message.includes('message channel closed')) {
                event.preventDefault();
                return;
            }
            // ë‹¤ë¥¸ ì¤‘ìš”í•œ ì˜¤ë¥˜ëŠ” ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ì•± ë™ì‘ì€ ê³„ì†
        });

        // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ (ì¼ë°˜ ì˜¤ë¥˜ ì²˜ë¦¬)
        window.addEventListener('error', function(event) {
            console.warn('Global error:', event.error);
            // ì•±ì˜ í•µì‹¬ ê¸°ëŠ¥ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ ì²˜ë¦¬
        });
    </script>
</body>
</html>